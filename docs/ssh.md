# SSH

_This document outlines the steps to setup and use SSH with my Mac as the client and a digitalocean droplet running Ubuntu 20.04 (LTS) as the server. Almost all information in this document is drawn from [SSH Essentials: Working with SSH Servers, Clients, and Keys](https://www.digitalocean.com/community/tutorials/ssh-essentials-working-with-ssh-servers-clients-and-keys) and [How To Configure SSH Key-Based Authentication on a Linux Server](https://www.digitalocean.com/community/tutorials/how-to-configure-ssh-key-based-authentication-on-a-linux-server)_.

## Introduction

SSH is an encrypted protocol that lets you (your computer...the client) execute shell commands on a computer somewhere else (a remote server) via the internet.

Clients must authenticate (prove that they are who they say that) when attempting to connect to a server. This can be done with a password but it is generally _much_ more sucure to use SSH keys.

> When a client connects to the host, wishing to use SSH key authentication, it will inform the server of this intent and will tell the server which public key to use. The server then checks its authorized_keys file for the public key, generates a random string, and encrypts it using the public key. This encrypted message can only be decrypted with the associated private key. The server will send this encrypted message to the client to test whether they actually have the associated private key.

> Upon receipt of this message, the client will decrypt it using the private key and combine the random string that is revealed with a previously negotiated session ID. It then generates an MD5 hash of this value and transmits it back to the server. The server already had the original message and the session ID, so it can compare an MD5 hash generated by those values and determine that the client must have the private key.

## Setting up and using SSH keys

### 1: Create a public/private key pair
This step is executed on a computer you want to use as an SSH client (your laptop or whatever).

Simply execute the following command:
```
% ssh-keygen
```
You'll see the following output:
```
Generating public/private rsa key pair.
Enter file in which to save the key (/Users/<your_user>/.ssh/id_rsa): 
```
Hit `enter` to keep things simple. You can enter an alternative filename under which to store your key pair if you want but using the default filename makes executing other SSH related commands simpler. You'd generally only enter an alternative filename if you want multiple key pairs on your computer (client) because doing so only adds complexity that is likely unnenessary for you.

If you have a perviously generated key stored at the default location on your client, you'll see output like this:
```
/Users/<your_user>/.ssh/id_rsa already exists.
Overwrite (y/n)? 
```
Type `y` for "yes" or `n` for "no" and hit enter. Choosing to overwrite will destroy the previously generated key pair. This means you'll need to copy your new public key to any server on which you used your old keys to authenticate. Only overwrite if someone harcked your private key or you have some other specific reason to do so.

The final step in generating a key pair is optionally creating a passphrase that is used to encrypt the private key on your computer.

```
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
```

This has the following benefits:

> - The private SSH key (the part that can be passphrase protected), is never exposed on the network. The passphrase is only used to decrypt the key on the local machine. This means that network-based brute forcing will not be possible against the passphrase.
> - The private key is kept within a restricted directory. The SSH client will not recognize private keys that are not kept in restricted directories. The key itself must also have restricted permissions (read and write only available for the owner). This means that other users on the system cannot snoop.
> - Any attacker hoping to crack the private SSH key passphrase must already have access to the system. This means that they will already have access to your user account or the root account. If you are in this position, the passphrase can prevent the attacker from immediately logging into your other servers. This will hopefully give you time to create and implement a new SSH key pair and remove access from the compromised key.

After you create (or choose not to create) a passphrase for your private key, you'll see something like:
```
Your identification has been saved in ~/.ssh/id_rsa
Your public key has been saved in ~/.ssh/id_rsa.pub
The key fingerprint is:
SHA256:/hk7MJ5n5aiqdfTVUZr+2Qt+qCiS7BIm5Iv0dxrc3ks user@host
```

You now have a public/private SSH key pair but before you can authenticate, you'll need to copy the **public** key to the server to which you wish to connect.

### 2: Copy your public key to the server

_This section assumes that your server is a digital ocean droplet running Ubuntu 20.04 LTS_

#### Using `ssh-copy-id`

This is the easiest way to copy your public key to a server and it's generally included in many OpenSSH packages. It requires password authentication to be enabled on your server.

Run the following command:
```
% ssh-copy-id <user>@<host>
```
The `<user>` will be the account you want to be able to login to the server with. If you haven't created a non-root user on your server, you'll use `root` as the value.

And the `<host>` will be the IP address of your droplet.

After you run the command, you'll likely see output like this:
```
The authenticity of host '203.0.113.1 (203.0.113.1)' can't be established.
ECDSA key fingerprint is fd:fd:d4:f9:77:fe:73:84:e1:55:00:ad:d6:6d:22:fe.
Are you sure you want to continue connecting (yes/no)?
```
Type `yes` and hit `enter`.

You'll see the following output which will include a prompt for the server's password. 
```
/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed
/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys
<user>@<host>'s password: 
```

If you get something like the output below instead of a password prompt, you likely just need to [enable SSH password authentication on your server](./ssh-config.md#enable-or-disable-password-authentication).
```
<user>@<host> Permission denied (publickey).
```

If when you successfully provide the server password, you'll see something like:
```
Number of key(s) added:        1

Now try logging into the machine, with:   "ssh '<user>@<host>'"
and check to make sure that only the key(s) you wanted were added.
```
You should now be able to SSH into your server!

### 3: Disable SSH password authentication on your server

With an SSH session, follow the steps in the [enable or disable password authentication](./ssh-config.md#enable-or-disable-password-authentication) section but set the `PasswordAuthentication` value as `no`
